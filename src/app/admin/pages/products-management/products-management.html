<section class="space-y-6">
  <!-- Page Title -->
  <div class="flex justify-between items-center gap-1 flex-wrap">
    <div>
      <h5 class="md:text-3xl sm:text-xl text-lg font-bold text-gray-800">Products</h5>
      <p class="text-gray-600">Manage your product inventory</p>
    </div>
    <div class="flex gap-2 flex-wrap">
      <app-button
        text="+ Add Product"
        size="md"
        type="green-outline"
        (handleOnlick)="showAddForm = true"
      ></app-button>
      <app-button
        text="+ Add Category"
        size="md"
        type="green-outline"
        (handleOnlick)="showAddCategoryForm.set(true)"
      ></app-button>
    </div>
  </div>

  <!-- Search and Filter -->
  <div class="bg-white rounded-lg shadow-md p-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <input
        type="text"
        placeholder="Search products..."
        [(ngModel)]="searchTerm"
        (input)="productService.setSearchQuery(searchTerm)"
        class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <select
        [(ngModel)]="selectedCategory"
        (change)="productService.setCategory(selectedCategory)"
        class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 capitalize"
      >
        <option value="">All Category</option>
        @for (item of categories(); track $index) {
          <option [value]="item.categoryName">{{ item.categoryName }}</option>
        }
      </select>
      <app-button
        text="ðŸ“¥ Export"
        size="lg"
        type="green-btn"
        (handleOnlick)="exportToCSV()"
      ></app-button>
    </div>
  </div>

  <!-- Products Table -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-gray-100 border-b">
            <th class="px-4 py-3 text-left">Product</th>
            <th class="px-4 py-3 text-left">Category</th>
            <th class="px-4 py-3 text-left">Price</th>
            <th class="px-4 py-3 text-left">Stock</th>
            <th class="px-4 py-3 text-left">Discount</th>
            <th class="px-4 py-3 text-left">Status</th>
            <th class="px-4 py-3 text-left">Actions</th>
          </tr>
        </thead>
        @if (productService.loading()) {
          <tr>
            <td colspan="6" class="text-center py-4">
              <app-loader></app-loader>
            </td>
          </tr>
        } @else {
          <tbody>
            @if (productService.getAllProducts().length === 0) {
              <tr>
                <td colspan="8" class="text-center py-6 text-gray-500">No products found.</td>
              </tr>
            } @else {
              @for (product of productService.getAllProducts(); track $index) {
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-4 py-3">
                    <div class="flex items-center space-x-2">
                      <img
                        [src]="productService.getImageUrl(product.productImg?.[0])"
                        alt="{{ product.productName }}"
                        class="w-10 h-10 object-cover rounded"
                      />

                      <div>
                        <p class="font-semibold capitalize">{{ product.productName }}</p>
                      </div>
                    </div>
                  </td>
                  <td class="px-4 py-3 capitalize">{{ product.productCategory }}</td>
                  <td class="px-4 py-3 font-semibold">
                    ${{ product.productPrice | number: '1.2-2' }}
                  </td>
                  <td class="px-4 py-3">
                    <span [class]="getStockColor(product.productInStock)">
                      {{ product.productInStock }}
                    </span>
                  </td>
                  <td class="px-4 py-3">
                    @if (product.productDiscount) {
                      <span
                        class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs font-semibold"
                      >
                        {{ product.productDiscount }}%
                      </span>
                    }
                    @if (!product.productDiscount) {
                      <span class="text-gray-500">-</span>
                    }
                  </td>
                  <td class="px-4 py-3">
                    <span
                      [class]="
                        product.productStatus
                          ? 'bg-green-100 text-green-800'
                          : 'bg-red-100 text-red-800'
                      "
                      class="px-3 py-1 rounded-full text-xs font-semibold"
                    >
                      {{ product.productStatus ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex gap-2">
                      <button
                        (click)="editProduct(product)"
                        class="text-blue-600 hover:text-blue-800 font-semibold"
                      >
                        Edit
                      </button>
                      <button
                        (click)="openDeleteConfirm(product)"
                        class="text-red-600 hover:text-red-800 font-semibold"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              }
            }
          </tbody>
        }
      </table>
    </div>
  </div>
</section>

<!-- Add/Edit Product Form -->
@if (showAddForm) {
  <div class="bg-black/50 w-full h-full flex items-center justify-center fixed inset-0 z-900 px-10">
    <div class="bg-white rounded-lg shadow-md p-6 w-140 h-150 max-w-full overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">
          {{ editingProduct ? 'Edit Product' : 'Add New Product' }}
        </h2>
        <button (click)="closeForm()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
      </div>

      <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Product Name * </label>
          <input
            type="text"
            [(ngModel)]="formData.productName"
            name="name"
            required
            #productName="ngModel"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Category * </label>
          <select
            [(ngModel)]="formData.productCategory"
            name="category"
            required
            #productCat="ngModel"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 capitalize"
          >
            <option value="">Select Category</option>
            @for (item of categoryService.categories(); track $index) {
              <option [value]="item.categoryName">{{ item.categoryName }}</option>
            }
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Price * </label>
          <input
            type="number"
            [(ngModel)]="formData.productPrice"
            name="price"
            step="0.01"
            required
            #productPrice="ngModel"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Original Price </label>
          <input
            type="number"
            [(ngModel)]="formData.originalPrice"
            name="originalPrice"
            step="0.01"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div> -->

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Stock * </label>
          <input
            type="number"
            [(ngModel)]="formData.productInStock"
            name="stock"
            required
            #productInStock="ngModel"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Discount (%) </label>
          <input
            type="number"
            [(ngModel)]="formData.productDiscount"
            name="discount"
            min="0"
            max="100"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Description * </label>
          <textarea
            [(ngModel)]="formData.productDesc"
            name="description"
            required
            #productDescription="ngModel"
            rows="4"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Images * </label>
          <input
            type="file"
            required
            multiple
            (change)="onFiles($event)"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          @if (imagePreviews) {
            <div class="mt-2 flex items-center gap-1">
              @for (item of imagePreviews; track $index) {
                <img [src]="item" alt="Preview" class="w-32 h-32 object-cover rounded" />
              }
            </div>
          }
        </div>

        <div class="flex items-center gap-1">
          <input
            type="checkbox"
            [(ngModel)]="formData.isFeatured"
            name="featured"
            id="featured"
            class="w-fit"
          />
          <label class="text-sm font-semibold text-gray-700" for="featured">
            Check if it's featured product.
          </label>
        </div>

        <div class="md:col-span-2 flex gap-2">
          @if (!editingProduct) {
            <app-button
              text="Add Product"
              type="green-btn"
              size="md"
              [disabled]="
                productName.invalid ||
                productCat.invalid ||
                productPrice.value === 0 ||
                productInStock.value === 0 ||
                productDescription.invalid ||
                selectedImgFiles.length === 0
              "
              [loading]="loading()"
              (handleOnlick)="saveProduct()"
            ></app-button>
          } @else {
            <app-button
              text="Update Product"
              type="green-btn"
              size="md"
              [disabled]="
                productName.invalid ||
                productCat.invalid ||
                productPrice.value === 0 ||
                productInStock.value === 0 ||
                productDescription.invalid ||
                selectedImgFiles.length === 0
              "
              (handleOnlick)="updateProduct()"
            ></app-button>
          }
          <app-button
            text="Cancel"
            type="gray-btn"
            size="md"
            (handleOnlick)="closeForm()"
          ></app-button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Add/Edit Category Form -->
@if (showAddCategoryForm()) {
  <div class="bg-black/50 w-full h-full flex items-center justify-center fixed inset-0 z-900 px-10">
    <div class="bg-white rounded-lg shadow-md p-6 w-140 h-80 max-w-full overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Add Category</h2>
        <button
          (click)="showAddCategoryForm.set(false)"
          class="text-gray-500 hover:text-gray-700 text-2xl"
        >
          âœ•
        </button>
      </div>

      <form class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2"> Category Name * </label>
          <input
            type="text"
            [(ngModel)]="categoryName"
            name="categoryName"
            required
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            #category="ngModel"
          />
        </div>

        <div class="flex items-center ga-3">
          <app-button
            text="Upload Category Image"
            type="gray-btn"
            size="md"
            (handleOnlick)="compressImg()"
          ></app-button>
          @if (imagePreview()) {
            <img [src]="imagePreview()" alt="" class="h-20 w-20 rounded-full" />
            <!-- <input
              type="text"
              [(ngModel)]="categoryObj.categoryImg"
              name="categoryImg"
              disabled
              class="w-full px-4 py-2 border rounded-lg disabled:bg-gray-600"
            /> -->
          }
        </div>

        <div class="flex justify-end items-center gap-2">
          <app-button
            text="Add Category"
            type="green-btn"
            size="md"
            [disabled]="category.invalid || !this.imagePreview()"
            [loading]="loading()"
            (handleOnlick)="addCategory()"
          ></app-button>
          <app-button
            text="Cancel"
            type="gray-btn"
            size="md"
            (handleOnlick)="showAddCategoryForm.set(false)"
          ></app-button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Confirm Delete Product -->
@if (confirmDeleteProduct()) {
  <div
    class="fixed inset-0 bg-black/50 h-screen w-full flex items-center justify-center z-900"
    data-aos="fade-in"
  >
    <div
      class="bg-white w-4/5 max-w-2xl rounded-md p-4 text-center flex flex-col justify-center gap-2 h-60"
    >
      <p class="text-black">Are you sure want to delete this product?</p>
      <div class="flex items-center justify-center gap-2">
        <app-button
          text="Cancel"
          type="gray-btn"
          size="md"
          (handleOnlick)="confirmDeleteProduct.set(false)"
        ></app-button>
        <app-button
          text="Delete"
          type="red-btn"
          size="md"
          [loading]="loading()"
          (handleOnlick)="deleteProduct()"
        ></app-button>
      </div>
    </div>
  </div>
}
